name: React Native
on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'demo/react-native/test-app/**'
      - 'lib/common/**'
      - 'lib/android/**'
      - 'lib/ios/**'
      - 'resources/keyword_files/android/**'
      - 'resources/keyword_files/ios/**'
      - '.github/workflows/react-native.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'demo/react-native/test-app/**'
      - 'lib/common/**'
      - 'lib/android/**'
      - 'lib/ios/**'
      - 'resources/keyword_files/android/**'
      - 'resources/keyword_files/ios/**'
      - '.github/workflows/react-native.yml'

defaults:
  run:
    working-directory: demo/react-native/test-app/PorcupineTestApp

jobs:
  test-android:
    name: Run tests on Android
    runs-on: pv-android

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: 'recursive'

    - name: Pre-build dependencies
      run: |
        yarn install
        ./copy_test_resources.sh

    - name: Pre-build environment
      run: |
        export ANDROID_HOME=/home/picovoice/Android/Sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$PATH:$ANDROID_HOME/emulator
        export PATH=$PATH:$ANDROID_HOME/platform-tools

    - name: Inject AppID
      run: sed -i 's:{TESTING_ACCESS_KEY_HERE}:${{secrets.PV_VALID_ACCESS_KEY}}:' Tests.ts

    - name: Build tests
      run: detox build --configuration android.emu.debug

    - name: Run tests
      run: detox test --configuration android.emu.debug
